# 2026-02-04 학습 내용

## 1. staleTime과 invalidateQueries의 관계

### 개념

TanStack Query에서 `invalidateQueries`를 호출해도 데이터가 즉시 refetch되지 않는 경우가 있다. 이는 전역 `staleTime` 설정과 관련이 있다.

### 문제 상황

```typescript
// providers.tsx - 전역 설정
const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 60 * 1000, // 1분
    },
  },
});

// mutation 성공 시
onSuccess: () => {
  queryClient.invalidateQueries({ queryKey: queryKeys.favorites.all });
  // 하지만 페이지 이동 시 refetch가 안 됨!
};
```

### 해결 방법

특정 쿼리에 `staleTime: 0`을 설정하여 항상 최신 데이터를 가져오도록 함:

```typescript
export const useFavorites = () => {
  return useQuery({
    queryKey: queryKeys.favorites.all,
    queryFn: () => get("/api/users/me/favorites"),
    staleTime: 0, // 전역 staleTime 무시, 항상 refetch
  });
};
```

### 핵심 포인트

- `invalidateQueries`는 쿼리를 "stale" 상태로 마킹
- 하지만 `staleTime` 내에 있으면 "fresh"로 간주되어 refetch 안 함
- 실시간성이 중요한 데이터는 `staleTime: 0` 설정 권장

---

## 2. useRef로 이벤트 리스너 메모리 누수 방지

### 문제 상황

`deviceorientation` 같은 이벤트 리스너를 콜백 내부에서 생성하면, 함수가 여러 번 호출될 때 중복 리스너가 등록됨:

```typescript
// ❌ 잘못된 패턴 - 메모리 누수 발생
const startTracking = useCallback(() => {
  const handleOrientation = (event) => {
    // ...
  };
  window.addEventListener("deviceorientation", handleOrientation);
  // 이전 리스너는 제거되지 않음!
}, []);
```

### 해결 방법

```typescript
// ✅ 올바른 패턴 - ref로 핸들러 관리
const orientationHandlerRef = useRef<((e: DeviceOrientationEvent) => void) | null>(null);

const startTracking = useCallback(() => {
  // 기존 리스너 제거
  if (orientationHandlerRef.current) {
    window.removeEventListener("deviceorientation", orientationHandlerRef.current, true);
  }

  const handleOrientation = (event) => {
    // ...
  };

  orientationHandlerRef.current = handleOrientation;
  window.addEventListener("deviceorientation", handleOrientation, true);
}, []);

// 언마운트 시 정리
useEffect(() => {
  return () => {
    if (orientationHandlerRef.current) {
      window.removeEventListener("deviceorientation", orientationHandlerRef.current, true);
      orientationHandlerRef.current = null;
    }
  };
}, []);
```

---

## 3. queryFn 순수성 유지

### 문제 상황

queryFn 내부에서 사이드 이펙트(로그아웃 등)를 실행하면 예측 불가능한 동작 발생:

```typescript
// ❌ 잘못된 패턴
useQuery({
  queryKey: ["user"],
  queryFn: async () => {
    const user = await fetchUser();
    if (!user) {
      logout(); // 사이드 이펙트!
    }
    return user;
  },
});
```

### 해결 방법

```typescript
// ✅ 올바른 패턴 - useEffect로 분리
const query = useQuery({
  queryKey: ["user"],
  queryFn: () => fetchUser(),
});

useEffect(() => {
  if (query.data === null && !query.isLoading) {
    logout();
  }
}, [query.data, query.isLoading, logout]);
```

---

## 4. isRequestOptions 타입 가드: some() vs every()

### 문제 상황

API 요청 함수에서 `data`와 `options`를 구분하는 타입 가드가 `some()`을 사용하면 잘못된 판단:

```typescript
// ❌ 잘못된 로직
function isRequestOptions(obj) {
  const keys = Object.keys(obj);
  const optionKeys = ["errorMessage", "allowUnauthorized", "transform"];
  return keys.some((key) => optionKeys.includes(key));
}

// { page: 1, errorMessage: "..." } → true로 잘못 판단!
// 실제로는 data인데 options로 처리됨
```

### 해결 방법

```typescript
// ✅ 올바른 로직
function isRequestOptions(obj) {
  const keys = Object.keys(obj);
  const optionKeys = ["errorMessage", "allowUnauthorized", "transform", "params", "headers"];
  // 모든 키가 옵션 키여야만 options로 인정
  return keys.length === 0 || keys.every((key) => optionKeys.includes(key));
}
```

---

## 5. Next.js Image fill과 sizes 속성

### 개념

`fill` 속성을 사용하는 Image 컴포넌트에는 `sizes` 속성이 필수. 없으면 경고 발생하고 성능 최적화가 안 됨.

### 예시

```tsx
// ❌ 경고 발생
<Image src={url} alt="image" fill className="object-cover" />

// ✅ 올바른 사용
<Image src={url} alt="image" fill sizes="85px" className="object-cover" />

// 반응형인 경우
<Image src={url} alt="image" fill sizes="(max-width: 768px) 100vw, 50vw" />
```

### sizes 값 가이드

| 상황      | sizes 값                           |
| --------- | ---------------------------------- |
| 고정 크기 | `"85px"`, `"100px"`                |
| 전체 너비 | `"100vw"`                          |
| 반응형    | `"(max-width: 768px) 100vw, 50vw"` |

---

## 참고 자료

- [TanStack Query - Important Defaults](https://tanstack.com/query/latest/docs/framework/react/guides/important-defaults)
- [Next.js Image Optimization](https://nextjs.org/docs/app/building-your-application/optimizing/images)
- [React useRef Hook](https://react.dev/reference/react/useRef)
